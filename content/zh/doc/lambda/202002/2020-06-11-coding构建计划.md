---
author: denalon
title: "2020 06 11 Coding构建计划"
linkTitle: "2020 06 11 Coding构建计划"
date: 2020-06-11T15:25:37+08:00
draft: false
url: /web/deploy/2020/202006112.html
description: > 
                2020 06 11 Coding构建计划
---

### coding构建计划：初见

![](https://cdn.jsdelivr.net/gh/denalon/gh-2/image/2020061131.png)

![](https://cdn.jsdelivr.net/gh/denalon/gh-2/image/2020061132.png)

![](https://cdn.jsdelivr.net/gh/denalon/gh-2/image/2020061133.png)

![](https://cdn.jsdelivr.net/gh/denalon/gh-2/image/2020061134.png)

![](https://cdn.jsdelivr.net/gh/denalon/gh-2/image/2020061135.png)


#### 代码
本站点使用coding的构建计划自动部署，代码如下：

```
pipeline {
  agent any
  stages {
    stage('检出') {
      steps {
        checkout([
          $class: 'GitSCM',
          branches: [[name: env.GIT_BUILD_REF]],
          userRemoteConfigs: [[
            url: env.GIT_REPO_URL,
            credentialsId: env.CREDENTIALS_ID
          ]]])
        }
      }
      stage('npm') {
        steps {
          sh 'npm init -y'
          sh 'npm install -D --save autoprefixer'
          sh 'npm install -D --save postcss-cli'
        }
      }
      stage('hugo') {
        steps {
          sh 'wget https://github.com/gohugoio/hugo/releases/download/v0.72.0/hugo_extended_0.72.0_Linux-64bit.tar.gz'
          sh 'tar -zxvf hugo_extended_0.72.0_Linux-64bit.tar.gz'
          sh './hugo'
        }
      }
      stage('未命名阶段') {
        steps {
          echo '构建中...'
          sh 'git clone http://XXXXX:XXXXXXXX@e.coding.net/denalon/web/dev.b.git'
          sh 'cp -R ./public/* ./dev.b'
        }
      }
      stage('发布') {
        steps {
          dir('./dev.b') {
            sh 'ls -a'
            sh 'git add .'
            sh 'git commit -m \'up\''
            sh 'git push -f http://XXXXX:XXXXXXXX@e.coding.net/denalon/web/dev.b.git master'
          }

          sh 'echo finish'
        }
      }
    }
  }
```
**此段代码为测试代码，不要将它保存在你的仓库里**

注意： 1 hugo的下载地址可以自己下载后，传到oss或cos以提高下载速度

2 XXXXX:XXXXXXXX 为自己的应用访问令牌，根据自己的设置替换。

3 push 的仓库地址 e.coding.net/denalon/web/dev.b.git 换成自己的



### 然而以上的设置并不是正常使用的

如果你的git仓库是公开的，而且你还将 Jenkinsfile 的配置文件保存在你的仓库，就会导致访问令牌泄露。解决方法：


将git地址在源码中替换为 env 环境变量，如下图。

![环境变量](https://cdn.jsdelivr.net/gh/denalon/ra-gh-3/image/2020/2020061103.png)

并将配置文件的代码修改为：

```
 pipeline {
  agent any
  stages {
    stage('检出') {
      steps {
        checkout([
          $class: 'GitSCM',
          branches: [[name: env.GIT_BUILD_REF]],
          userRemoteConfigs: [[
            url: env.GIT_REPO_URL,
            credentialsId: env.CREDENTIALS_ID
          ]]])
        }
      }
      stage('npm') {
        steps {
          sh 'npm init -y'
          sh 'npm install -D --save autoprefixer'
          sh 'npm install -D --save postcss-cli'
        }
      }
      stage('hugo') {
        steps {
          sh 'wget https://vendor.ufs.pub/hugo_extended_0.72.0_Linux-64bit.tar.gz'
          sh 'tar -zxvf hugo_extended_0.72.0_Linux-64bit.tar.gz'
          sh './hugo'
        }
      }
      stage('未命名阶段') {
        steps {
          echo '构建中...'
          sh 'git clone https://${B_USER}:${B_TOKEN}@${B_GIT}'
          sh 'cp -R ./public/* ./dev.b'
        }
      }
      stage('发布') {
        steps {
          dir('./dev.b') {
            sh 'ls -a'
            sh 'git add .'
            sh 'git commit -m \'up\''
            sh 'git push -f https://${B_USER}:${B_TOKEN}@${B_GIT} master'
          }

          sh 'echo finish'
        }
      }
    }
  }
```

就可以将coding构建计划的配置文件保存在代码库里

### 后续计划
将content 以子模块形式调用