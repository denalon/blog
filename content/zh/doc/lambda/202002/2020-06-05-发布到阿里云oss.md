---
author: denalon
title: "2020 06 05 发布到阿里云oss"
linkTitle: "2020 06 05 发布到阿里云oss"
date: 2020-06-05T17:06:53+08:00
draft: false
url: /web/deploy/2020/2020060517.html
description: > 
                2020 06 05 发布到阿里云oss
---

###通过以下代码将github内容发布到oss

位于.github/workflows/main.yml

```
name: MainWorkflow

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
    - uses: actions/setup-node@v1
      with:
        node-version: "12.x"

    - uses: manyuanrong/setup-ossutil@v1.0
      with:
        # endpoint 可以去oss控制台上查看
        endpoint: "oss-cn-zhangjiakou.aliyuncs.com"
        # 使用我们之前配置在secrets里面的accesskeys来配置ossutil
        access-key-id: ${{ secrets.OSS_KEY_ID }}
        access-key-secret: ${{ secrets.OSS_KEY_SECRET }}
    - name: Deply To OSS
      run: ossutil cp ./public oss://hb-kit-t7/ -rf
      
```

### 在github上运行持续集成


自动使用hugo生成public

```
name: Deploy Hugo Site to Github Pages on Master Branch

on:
  push:
    branches:
      - master

jobs:
  build-deploy:
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v1  # v2 does not have submodules option now
       # with:
       #   submodules: true

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: '0.62.2'
          # extended: true

      - name: Build
        run: hugo --minify

      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          deploy_key: ${{ secrets.ACTIONSDEPLOYKEY }} # 这里的 ACTIONS_DEPLOY_KEY 则是上面设置 Private Key的变量名
          external_repository: denalon/denalon.github.io # Pages 远程仓库 
          publish_dir: "/deploy/public"
          keep_files: false # remove existing files
          publish_branch: master  # deploying branch
          commit_message: ${{ github.event.head_commit.message }}

```


git镜像到其他仓库

```
name: 'GitHub Actions Mirror'

on: [push, delete]

jobs:
  mirror_to_gitlab:
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v1
      - name: 'Mirror to gitlab'
        uses: pixta-dev/repository-mirroring-action@v1
        with:
          target_repo_url:
            git@gitlab.com:denalon/pages.git
          ssh_private_key:
            ${{ secrets.PAGES }}
```

更换目录名

```
name: Deploy Hugo Site to Github Pages on Master Branch

on:
  push:
    branches:
      - master

jobs:
  build-deploy:
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v1  # v2 does not have submodules option now
       # with:
       #   submodules: true

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: '0.62.2'
          # extended: true

      - name: Build
        run: hugo --minify

      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          deploy_key: ${{ secrets.DEPLOY }} # 这里的 ACTIONS_DEPLOY_KEY 则是上面设置 Private Key的变量名
          external_repository: denalon/deploy # Pages 远程仓库 
          publish_dir: "/deploy"
          keep_files: false # remove existing files
          publish_branch: master  # deploying branch
          commit_message: ${{ github.event.head_commit.message }}

```

### 实现的效果

1 通过hugo命令生成一个 站点目录/deploy/public文件夹

2 进入deploy目录下，使用git add . 和git commit -m "XXXx" git push命令，将此目录下所有文件上传到github仓库pages里，同时运行下列3和4 。

3 推送到github仓库后，github actions 启动命令 将./public文件夹的内容推送到阿里云oss

4 推送到github仓库后，github actions启动命令，将整个站点文件，包含一个.gitlab-ci.yml 和public文件夹推送到gitlab 仓库 pages里。

5 github仓库pages接受到github的推送以后，启动.gitlab-ci.yml文件，自动部署pages服务。
