---
author: denalon
title: "新的更新方法"
linkTitle: "2020 07 02新的更新方法"
date: 2020-07-03
draft: false
url: /web/docs/2020/2020070297.html
description: "新的更新方法"
---

### git仓库多处推送

为了避免个人失误或者其他故障造成git仓库被删除，丢失。我总是将一个git仓库同时推送到github，gitlab，coding，阿里云code等地。之前的方式在是本地操作执行`git remote set-url --add origin xxxx.git`这主要是为了防止不经意间的错误删除和修改。

但是每次git clone 以后都需要增加几个备份用的`git remote` 显得太过繁琐，特别是部署持续集成之后，所有的代码都完全交给git代码托管，本地使用时对特定内容进行`git clone`即可。这种操作简化了操作步骤，但损失了同时推送到多个仓库的备份。

### 新的多仓库备份

在coding上创建一个空的仓库，上传代码如下：
注意：***密钥内容不可见*** 为替换掉的私钥内容。

```
pipeline {
  agent any
  stages {
    stage('检出') {
      steps {
        checkout([
          $class: 'GitSCM',
          branches: [[name: env.GIT_BUILD_REF]],
          userRemoteConfigs: [[
            url: env.GIT_REPO_URL,
            credentialsId: env.CREDENTIALS_ID
          ]]])
        }
      }
      stage('并行阶段 1') {
        parallel {
          stage('拉取B仓库') {
            steps {
              sh 'git clone https://${B_USER}:${B_TOKEN}@e.coding.net/denalon/code/b.git'
            }
          }
          stage('拉取lambda仓库') {
            steps {
              sh 'git clone https://${B_USER}:${B_TOKEN}@e.coding.net/denalon/dev/lambda.git'
            }
          }
          stage('拉取note仓库') {
            steps {
              sh 'git clone https://${B_USER}:${B_TOKEN}@e.coding.net/denalon/kit/note.git'
            }
          }
        }
      }
      stage('改写ssh') {
        steps {
          sh 'ls -a'
          writeFile(file: 'ssh.md', text: '''-----BEGIN RSA PRIVATE KEY-----
***密钥内容不可见***
-----END RSA PRIVATE KEY-----''')
          sh 'mkdir -p ~/.ssh'
          sh 'cat ./ssh.md > ~/.ssh/id_rsa'
          sh 'chmod 600 ~/.ssh/id_rsa'
        }
      }
      stage('上传') {
        steps {
          dir('./note') {
            sh 'git remote set-url --add origin git@codeup.aliyun.com:dev/note/note.git'
            sh 'git remote set-url --add origin git@github.com:denalon/note.git'
            sh 'git remote set-url --add origin git@gitlab.com:denalon/note.git'
            sh 'git remote set-url --add origin git@ssh.dev.azure.com:v3/denalon/b/note'
            sh 'git fetch'
            sh 'git push origin master -f'
          }

          dir('./lambda') {
            sh 'git remote set-url --add origin git@codeup.aliyun.com:dev/note/lambda.git'
            sh 'git remote set-url --add origin git@github.com:denalon/lambda.git'
            sh 'git remote set-url --add origin git@gitlab.com:denalon/lambda.git'
            sh 'git remote set-url --add origin git@ssh.dev.azure.com:v3/denalon/b/lambda'
            sh 'git fetch'
            sh 'git push origin master -f'
          }

          dir('./b') {
            sh 'git remote set-url --add origin git@github.com:denalon/b.git'
            sh 'git remote set-url --add origin git@codeup.aliyun.com:dev/code/b.git'
            sh 'git remote set-url --add origin git@gitlab.com:denalon/b.git'
            sh 'git remote set-url --add origin git@ssh.dev.azure.com:v3/denalon/b/b'
            sh 'git fetch'
            sh 'git push origin master -f'
          }

        }
      }
    }
  }
  ```

### 作用

以coding代码为主，定期或随push触发，将coding的代码clone以后，推送的其他仓库上。做到在持续集成环境上自动备份。