---
title: "blog代码"
linkTitle: "blog代码"
description: "部署在blog.holz.pub上的构建计划配置代码"
author: denalon
date: 2020-08-31T09:01:40+08:00
url: /web/note/2020083103.html
---

### blog

```
pipeline {
  agent any
  stages {
    stage('检出') {
      steps {
        checkout([
          $class: 'GitSCM',
          branches: [[name: env.GIT_BUILD_REF]],
          userRemoteConfigs: [[
            url: env.GIT_REPO_URL,
            credentialsId: env.CREDENTIALS_ID
          ]]])
        }
      }
      stage('改写ssh') {
        steps {
          sh 'ls -a'
          sh 'mkdir -p ~/.ssh'
          withCredentials([ sshUserPrivateKey(credentialsId:'15a357be-78af-4353-ae31-aa6d14fa6c0d',keyFileVariable:'SSH')
                                                                                                                      ]) {
            sh 'cat ${SSH} > ~/.ssh/id_rsa'
          }

          sh 'chmod 600 ~/.ssh/id_rsa'
        }
      }
      stage('更新子模块') {
        steps {
          sh 'git submodule init'
          sh 'git submodule update'
          sh 'git submodule foreach \'git pull origin master\''
        }
      }
      stage('npm') {
        steps {
          sh 'npm init -y'
          sh 'npm install -g cnpm --registry=https://registry.npm.taobao.org'
          sh 'cnpm install -D --save autoprefixer'
          sh 'cnpm install -D --save postcss-cli'
        }
      }
      stage('hugo') {
        steps {
          sh 'git clone git@e.coding.net:denalon/asset/app.git'
          dir('./app') {
            sh 'tar -zxvf hugo.tar.gz'
            sh 'cp ./hugo /usr/local/bin/'
          }

          sh 'hugo'
          sh 'hugo --environment deploy'
        }
      }
      stage('并行阶段 1') {
        parallel {
          stage('发布') {
            steps {
              dir('./deploy/public') {
                sh 'ls -a'
                sh 'git init'
                sh 'git remote add origin git@e.coding.net:nierheim/web/pages.git'
                sh 'git remote set-url --add origin git@github.com:denalon/denalon.github.io.git'
                sh 'git add .'
                sh 'git commit -m "up"'
                sh 'git push origin master -f'
              }

            }
          }
          stage('测试文件') {
            steps {
              dir('./deploy') {
                sh 'ls -a'
              }

            }
          }
        }
      }
      stage('上传oss') {
        steps {
          sh 'wget http://gosspublic.alicdn.com/ossutil/1.6.14/ossutil64'
          sh 'mv ossutil64 ossutil'
          sh 'chmod 755 ossutil'
          sh 'ls -a'
          sh './ossutil config -e ${OSS_EP} -i ${OSS_ID} -k ${OSS_KEY}'
          sh './ossutil cp ./public oss://blog1-web-holz/ -rf'
        }
      }
    }
  }
  ```